<head>
  <!-- Meta -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Kubek - Minecraft Servers</title>

  <!-- MDB -->
  <script src="js/mdb.min.js"></script>
  <link rel="stylesheet" href="css/mdb.min.css">

  <!-- Others -->
  <script src="js/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="css/animate.min.css" />
  <link rel="stylesheet" href="css/toastify.min.css" />
  <script src="js/socket.io.min.js"></script>
  <script src="js/toastify-js.js"></script>
  <script src="js/sweetalert2.all.min.js"></script>

  <!-- Own -->
  <link rel="stylesheet" href="css/globals.css" />
  <link rel="stylesheet" href="css/template.nav.css" />
  <script src="js/funcs.js"></script>
  <script src="js/sweetalert2.all.min.js"></script>

  <!-- Fonts and icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Open Sans:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
    rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Page unique -->
  <link rel="stylesheet" href="css/pages/plugins.css">

  <!-- 
    #repos-plugins (node)
    #installed-plugins (node)
    #upload-plugin (event)
    #search-input (event)
  -->
</head>

<body>
  <div id="oldc">
    <form id="g-plugin-form" enctype="multipart/form-data">
      <input name="g-plugin-input" id="g-plugin-input"
        style="position: absolute; left: -2582px; right: 0; top: 0; bottom: 0; z-index: -285;" type="file"
        accept=".jar">
    </form>

    <span class="fs-1 fw-bold">{{plugins}}</span>
    <div class="win-fullscreen">
      <div class="caption1">{{repo-uppercase}}</div>
      <div class="caption2">{{installed-uppercase}}</div>
      <div class="search d-flex">
        <input type="text" class="flex-fill" id="search-input" placeholder="Поиск">
        <button type="button" class="btn btn-secondary btn-sm" onclick="prevPage()"><span
            class="material-icons material-icons-outlined" style="font-size: 12pt;">keyboard_arrow_left</span></button>
        <button type="button" class="btn btn-secondary btn-sm" onclick="nextPage()"><span
            class="material-icons material-icons-outlined" style="font-size: 12pt;">keyboard_arrow_right</span></button>
        <button onclick="uploadPluginOwn()" class="btn btn-primary btn-floating"
          style="margin-left: 10px; height: 26px; width: 2.1rem;"><span class="material-icons" style="font-size: 10pt;"
            id="upload-plugin">upload_file</span></button>
      </div>
      <div class="repository" id="repos-plugins">
        <ul class="list-group list-group-flush"></ul>
      </div>
      <div class="installed" id="installed-plugins">
        <ul class="list-group list-group-flush"></ul>
      </div>
    </div>
  </div>
</body>

<script>
  var socket;
  var queryUpdInterval;
  var page = 1;

  $(document).ready(function () {
    loadTemplate(function () {
      hideLoading();
      $("#search-input").keydown(function (e) {
        if (e.keyCode == 13) {
          showLoading();
          $("#repos-plugins .list-group").html("");
          $.get("/plugin/search?search=" + $("#search-input").val(), function (data) {
            data.forEach(function (plugin) {
              if (typeof plugin.image_url !== "undefined") {
                $("#repos-plugins .list-group").append('<li data-url="' + plugin.url +
                  '" data-download-url="' +
                  plugin.download_url +
                  '" class="list-group-item d-flex justify-content-center align-items-center w-100"> <img src="' +
                  plugin.image_url +
                  '" width=24 height=24 class="circle"> <span class="flex-fill" style="margin-left: 16px;">' +
                  plugin.name + '</span> </li>');
              } else {
                $("#repos-plugins .list-group").append('<li data-url="' + plugin.url +
                  '" data-download-url="' +
                  plugin.download_url +
                  '" class="list-group-item d-flex justify-content-center align-items-center w-100"> <img width=24 height=24 class="circle"> <span class="flex-fill" style="margin-left: 16px;">' +
                  plugin.name + '</span> </li>');
              }
            });
            $("#repos-plugins .list-group li").click(function () {
              openCPBG(this);
            });
            hideLoading();
          });
        }
      });
      updateFromPage();
    });
    socket = openSocket();
    socket.on("handshake", function () {
      console.log("Socket handshake success");
      $.get("/plugin/installed?server=" + currentServer, function (plugins) {
        $("#installed-plugins .list-group").html("");
        plugins.forEach(function (plugin) {
          pname = plugin.replace(".jar", "");
          $("#installed-plugins .list-group").append(
            '<li class="list-group-item d-flex justify-content-center align-items-center w-100"> <span class="flex-fill">' +
            pname +
            '</span> <div class="align-self-end"> <button type="button" style="height: 32px; width: 32px;" class="btn btn-danger btn-floating text-white" title="{{delete-plugin}}" onclick="deletePlugin(' +
            "'" + plugin + "'" +
            ')"> <span class="material-icons" style="font-size: 14pt;">delete</span> </button> </div> </li>'
          );
        });
      });
      socket.emit("update", {
        type: "servers"
      });
      queryUpdInterval = setInterval(function () {
        if ($("#server-status").text() == "Online") {
          socket.emit("update", {
            type: "query",
            server: currentServer
          });
        }
      }, 6000);
      if ($("#server-status").text() == "Online") {
        socket.emit("update", {
          type: "query",
          server: currentServer
        });
      }
    });
    socket.on("handleUpdate", function (arg) {
      type = arg.type;
      data = arg.data;
      switch (type) {
        case "servers":
          if (data[currentServer].status == "stopped") {
            $("#server-status").removeClass("badge-success badge-warning");
            $("#server-status").addClass("badge-danger");
            $("#server-status").html("Offline");
            $("#server-start-button").show();
            $("#server-stop-button").hide();
          } else if (data[currentServer].status == "started") {
            $("#server-status").removeClass("badge-danger badge-warning");
            $("#server-status").addClass("badge-success");
            $("#server-status").html("Online");
            $("#server-start-button").hide();
            $("#server-stop-button").show();
          } else if (data[currentServer].status == "starting") {
            $("#server-status").removeClass("badge-success badge-danger");
            $("#server-status").addClass("badge-warning");
            $("#server-status").html("Starting");
            $("#server-start-button").hide();
            $("#server-stop-button").hide();
          } else if (data[currentServer].status == "stopping") {
            $("#server-status").removeClass("badge-success badge-danger");
            $("#server-status").addClass("badge-warning");
            $("#server-status").html("Stopping");
            $("#server-start-button").hide();
            $("#server-stop-button").hide();
          }
          break;
        case "downloadTasks":
          $(".ntc-pool").html("");
          Object.keys(data).forEach(function (k) {
            $(".ntc-pool").append(
              '<div class="ntc ntc-poolbox" style="background: rgb(43,53,63); color: white;"><div class="ntb">Downloading ' +
              k + ' (' + data[k] + '%)</div><div class="ntb"><progress max="100" value="' + data[k] +
              '" class="pnf"></progress></div></div>');
          });
          break;
      }
    });
  });

  function deletePlugin(plugin) {
    $.get("/plugin/delete?file=" + plugin + "&server=" + currentServer, function (data) {
      window.location.reload();
    });
  }

  function uploadPluginOwn() {
    $("#g-plugin-input").trigger('click');
    $("#g-plugin-input").off("change");
    $("#g-plugin-input").change(function () {
      var formData = new FormData($("#g-plugin-form")[0]);
      jQuery.ajax({
        url: '/plugin/upload?server=' + currentServer,
        type: "POST",
        data: formData,
        success: function (data) {
          Swal.fire(
            '{{success}}',
            '{{restartServerToSeeChanges}}',
            'success'
          ).then((result) => {
            window.location = "";
          });
        },
        error: function (data) {
          Swal.fire(
            '{{error}}',
            '{{ErrorWhileUploadingCore}}',
            'error'
          );
        },
        cache: false,
        contentType: false,
        processData: false,
      });
    });
  }

  function prevPage() {
    if (page != 1) {
      page--;
      updateFromPage();
    }
  }

  function nextPage() {
    page++;
    updateFromPage();
  }

  function openCPBG(elem) {
    $("body").append("<div class='cp-bg'></div>");
    $(".layout").addClass("layblur");
    $("body").append(
      '<div class="cp-abs"><div class="icon"></div><div class="name"></div><div class="btnh w-100"></div><div class="selecth"></div></div>'
    );
    $(".cp-abs").fadeIn(200);
    $(".cp-abs .icon").html($(elem).find("img")[0].outerHTML);
    $(".cp-abs .name").html($(elem).find(".flex-fill").text());
    $(".cp-abs .selecth").html("Загрузка версий...");
    purl = $(elem).data("url");
    $.get("/plugin/versions?url=" + purl, function (versions) {
      html = "<select>";
      versions.forEach(function (version, i) {
        html += "<option data-download='" + version.url + "'>" + version.name + "</option>";
      });
      html += "</select>";
      $(".cp-abs .selecth").html(html);
      $(".cp-abs .btnh").html(
        "<button class='btn btn-success btn-sm w-100' onclick='installCP()'>{{install}}</button><br><button class='btn btn-dark btn-sm w-100' onclick='$(" +
        '".cp-abs"' + ").remove();$(" + '".cp-bg"' + ").remove();$(" + '".layout"' + ").removeClass(" +
        '"layblur"' + ")'>{{cancel}}</button>");
    });
  }

  function installCP() {
    fnn = $(".cp-abs .name").html().split(" ").join("_") + "-" + $(
      ".cp-abs .selecth select option:selected").html().split(" ").join("_") + ".jar";
    urll = $(".cp-abs .selecth select option:selected").data("download");
    $.get("/file/download?filename=" + fnn + "&url=" + urll + "&server=" + currentServer + "&type=plugin");
    $(".cp-abs").remove();
    $(".cp-bg").remove();
    $(".layout").removeClass("layblur");
  }

  function updateFromPage() {
    showLoading();
    $.get("/plugin/page?pg=" + page, function (data) {
      $("#repos-plugins .list-group").html("");
      data.forEach(function (plugin) {
        if (typeof plugin.image_url !== "undefined") {
          $("#repos-plugins .list-group").append('<li data-url="' + plugin.url + '" data-download-url="' +
            plugin.download_url +
            '" class="list-group-item d-flex justify-content-center align-items-center w-100"> <img src="' +
            plugin.image_url +
            '" width=24 height=24 class="circle"> <span class="flex-fill" style="margin-left: 16px;">' +
            plugin.name + '</span> </li>');
        } else {
          $("#repos-plugins .list-group").append('<li data-url="' + plugin.url + '" data-download-url="' +
            plugin.download_url +
            '" class="list-group-item d-flex justify-content-center align-items-center w-100"> <img width=24 height=24 class="circle"> <span class="flex-fill" style="margin-left: 16px;">' +
            plugin.name + '</span> </li>');
        }
      });
      $("#repos-plugins .list-group li").click(function () {
        openCPBG(this);
      });
      hideLoading();
    });
  }
</script>