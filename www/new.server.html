<head>
  <!-- Meta -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Kubek</title>

  <!-- MDB -->
  <script src="/js/mdb.min.js"></script>
  <link rel="stylesheet" href="/css/mdb.min.css">

  <!-- Others -->
  <script src="/js/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="/css/animate.min.css" />

  <!-- Own -->
  <link rel="stylesheet" href="/css/globals.css" />
  <script src="/js/funcs.js"></script>

  <!-- Icons and font -->
  <link rel="stylesheet" href="/fonts/Inter/stylesheet.css" />
  <link rel="stylesheet" href="/fonts/MaterialSymbols/stylesheet.css" />
</head>

<form id="g-core-form" enctype="multipart/form-data">
  <input type="file" style="position: absolute; left: -2582px; right: 0; top: 0; bottom: 0; z-index: -285;"
    id="g-core-input" name="g-core-input" accept=".jar" />
</form>

<div class="card" id="progress-card"
  style="display: none; margin: auto; position: absolute; left: 0; right: 0; top: 0; bottom: 0; width: max-content; height: max-content; z-index: 999999999; min-width: 30%;">
  <div class="card-body">
    <p class="card-text">
      Loading
    </p>
    <div class="progress">
      <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0"
        aria-valuemax="100"></div>
    </div>
    <div
      style="background: rgb(240,240,240); width: 700px; height: 500px; overflow: auto; margin-top: 6px; border-radius: 4px; display: none;"
      id="forgeins"></div>
  </div>
</div>

<div id="loading-overlay" class="w-100 h-100 justify-content-center align-items-center"
  style="width: 110% !important; height: 120% !important; margin: auto !important; left: -10% !important; display: flex;">
  <div class="spinner-border text-primary" style="width: 5rem; height: 5rem;" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>

<body>
  <div class="layout">
    <div class="header">
      <div class="d-flex flex-row mb-3 align-items-center" id="logo-flex">
        <div class="p-2">
          <img src="/assets/icon.png" height="56">
        </div>
        <div class="p-2 ms-3 kubekLogoText">Kubek</div>
      </div>

      <div class="progress" style="height: 20px;">
        <div class="progress-bar" role="progressbar" style="width: 33%;"></div>
      </div>

      <p id="current-stage-text">{{select-core-sw}}</p>
    </div>
    <div class="content">
      <div id="first-stage">
        <div class="input-group mb-3" style="margin-top: -10%;">
          <input type="text" class="form-control" placeholder="{{enter-new-sn-sw}}" />
        </div>
      </div>

      <div id="second-stage" style="display: none;">
        <div class="d-flex flex-row justify-content-evenly">
          <div class="card active" data-core="paper">
            <img alt="PaperMC Core" src="/assets/stages_bg/paper.png" width="64" class="card-img-top" />
            <div class="card-body">
              <h5 class="card-title">PaperMC</h5>
              <ul>
                {{papermc-desc-sw}}
              </ul>
              <select id="paper-versel"></select>
            </div>
          </div>
          <div class="card" data-core="spigot">
            <img alt="Spigot Core" src="/assets/stages_bg/spigotmc.png" width="64" class="card-img-top" />
            <div class="card-body">
              <h5 class="card-title">Spigot</h5>
              <ul>
                {{spigot-desc-sw}}
              </ul>
              <select id="spigot-versel"></select>
            </div>
          </div>
          <div class="card" data-core="own">
            <img alt="Upload my core" src="/assets/stages_bg/upload.png" width="64" class="card-img-top" />
            <div class="card-body">
              <h5 class="card-title">{{upload-core-sw}}</h5>
              <p class="card-text">{{upload-core-sw}}</p>
              <p style="font-size: 11pt; color: rgb(170,170,170);">{{forge-autoins-msg-sw}}</p>
            </div>
          </div>
        </div>
      </div>

      <div id="third-stage" style="display: none;">
        <p>{{selected-core-sw}}: <span class="corever"></span></p>
        <p>{{selected-sn-sw}}: <span class="sn"></span></p>

        <div class="input-group mb-3" style="height: 40px;">
          <button class="btn btn-primary shadow-0 dropdown-toggle" type="button" data-mdb-toggle="dropdown" aria-expanded="false"
            id="cur-jv" style="height: 40px;"></button>
          <ul class="dropdown-menu" id="java-vers-dropdown"></ul>
          <input type="text" class="form-control" id="fsc" aria-label="Full start command input"
            style="height: 40px;" />
        </div>
        <p class="req-java" style="color: rgb(130,130,130); font-size: 11pt;"></p>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="" id="javaOptiflagsCheckbox"
            onchange="generateJavaStartup()" />
          <label class="form-check-label" for="javaOptiflagsCheckbox">{{add-opti-java-flags-sw}}</label>
        </div>

        <div class="w-100 d-inline-flex justify-content-between" style="margin-top: 12px;">
          <div class="input-group mb-3" style="width: 48%; height: 40px;">
            <span class="input-group-text" id="basic-addon1">{{memory}} (-Xmx)</span>
            <input type="number" class="form-control" placeholder="{{memory}} (-Xmx)" aria-label="{{memory}} (-Xmx)"
              aria-describedby="basic-addon1" min=0.5 max=4 step=0.5 id="xmx" onchange="generateJavaStartup()"
              style="height: 40px;" />
            <span class="input-group-text" id="basic-addon1">GB</span>
          </div>
          <div class="input-group mb-3" style="width: 48%; height: 40px;">
            <span class="input-group-text" id="basic-addon1">{{server-port}}</span>
            <input type="number" class="form-control" placeholder="Server port" aria-label="Server port"
              aria-describedby="basic-addon1" value=25565 min=20000 max=65000 step=1 id="serverport"
              style="height: 40px;" />
          </div>
        </div>

        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="" id="onlinemodeCheckbox" />
          <label class="form-check-label" for="onlinemodeCheckbox">online-mode</label>
        </div>
      </div>
    </div>
    <div class="buttons">
      <button type="button" class="btn btn-secondary shadow-0" style="display: none;" id="backbtn">
        < {{back}}</button> <button type="button" class="btn btn-secondary shadow-0" id="nextbtn">{{next}} >
      </button>
    </div>
</body>

<script>
  var currentStage = "";
  var nameRegex = /^[a-zA-Z0-9_.-]*$/gm;
  var selectedCore = "";
  var selectedCoreVersion = "";
  var javaOptimizeString =
    "-XX:+UseG1GC -XX:+ParallelRefProcEnabled -XX:MaxGCPauseMillis=200 -XX:+UnlockExperimentalVMOptions -XX:+DisableExplicitGC -XX:+AlwaysPreTouch -XX:G1HeapWastePercent=5 -XX:G1MixedGCCountTarget=4 -XX:G1MixedGCLiveThresholdPercent=90 -XX:G1RSetUpdatingPauseTimePercent=5 -XX:SurvivorRatio=32 -XX:+PerfDisableSharedMem -XX:MaxTenuringThreshold=1 -XX:G1NewSizePercent=30 -XX:G1MaxNewSizePercent=40 -XX:G1HeapRegionSize=8M -XX:G1ReservePercent=20 -XX:InitiatingHeapOccupancyPercent=15";

  $(document).ready(function () {
    $("#g-core-input").val("");
    $("#g-core-form").val("");
    console.log('[UI]', 'Document is ready');
    $("#current-stage-text").text("{{ns-name-sw}}");
    $("#first-stage").show();
    $("#second-stage").hide();
    $(".form-control").val("");
    currentStage = 1;
    console.log('[UI]', 'Stage 1 active');
    $.get("/kubek/usage", function (usage) {
      total = round512(Math.round(usage.totalmem / 1024 / 1024));
      ttl = (total / 1024).toFixed(1) / 2;
      max = (total / 1024).toFixed(1);
      $("#xmx").val(ttl);
      $("#xmx").attr("max", max);
      generateJavaStartup();
    });
    loadCores();
    setTimeout(function () {
      hideLoading();
    }, 500);
  });

  $("#backbtn").click(function () {
    console.log('[UI]', 'BACK button clicked');
    if (currentStage == 2) {
      console.log('[UI]', 'Current stage - 2, going to stage 1');
      $("#backbtn").hide();
      $("#second-stage").fadeOut(50, function () {
        $("#second-stage").hide();
        $("#first-stage").show();
        $("#first-stage").fadeIn();
        $(".progress-bar").css("width", "33%");
        currentStage = 1;
        $("#current-stage-text").text("{{ns-name-sw}}");
        console.log('[UI]', 'Stage 1 active');
      });
    }
  });

  $("#nextbtn").click(function () {
    console.log('[UI]', 'NEXT button clicked');
    if (currentStage == 1) {
      console.log('[UI]', 'Current stage - 1, going to stage 2');
      text = $(".form-control").val();
      if (text.length >= 2 && text.length <= 32 && text.match(nameRegex) !== "undefined" && text.match(nameRegex) !=
        null) {
        $("#backbtn").show();
        $("#first-stage").fadeOut(50, function () {
          $("#first-stage").hide();
          $("#second-stage").show();
          $("#second-stage").fadeIn();
          $(".progress-bar").css("width", "66%");
          currentStage = 2;
          $("#current-stage-text").text("{{select-core-sw}}");
          console.log('[UI]', 'Stage 2 active');
        });
      }
    } else if (currentStage == 2) {
      selectedCore = $("#second-stage .card.active").data("core");
      selectedCore = selectedCore.charAt(0).toUpperCase() +
        selectedCore.slice(1);
      selectedCoreVersion = null;
      if (selectedCore == "Spigot") {
        selectedCoreVersion = $("#spigot-versel").val();
      }
      if (selectedCore == "Paper") {
        selectedCoreVersion = $("#paper-versel").val();
      }
      if (selectedCoreVersion != null) {
        $.get("/kubek/verToJava?version=" + selectedCoreVersion, function (jv) {
          $("#third-stage .req-java").text("{{recomm-java-msg-sw}} " + jv);
        });
      } else {
        $("#third-stage .req-java").text("");
      }
      if ($("#second-stage .card.active").data("core") == "own") {
        $("#g-core-input").trigger('click');
        $("#g-core-input").off("change");
        $("#g-core-input").change(function () {
          $("#first-stage").hide();
          $("#second-stage").hide();
          $("#third-stage").show();
          $("#third-stage").fadeIn();
          $(".progress-bar").css("width", "100%");
          currentStage = 3;
          $("#current-stage-text").text("{{finalize-new-sn-sw}}");
          console.log('[UI]', 'Stage 3 active');
          loadThirdStage();
        });
      } else {
        $("#first-stage").hide();
        $("#second-stage").hide();
        $("#third-stage").show();
        $("#third-stage").fadeIn();
        $(".progress-bar").css("width", "100%");
        currentStage = 3;
        $("#current-stage-text").text("{{finalize-new-sn-sw}}");
        console.log('[UI]', 'Stage 3 active');
        loadThirdStage();
      }
    } else if (currentStage == 3) {
      createServer();
    }
  });

  function generateJavaStartup() {
    sl = "";
    sl += "-Xmx" + Math.round($("#xmx").val() * 1024) + "M";
    sl += " ";
    if ($("#javaOptiflagsCheckbox").is(":checked")) {
      sl += javaOptimizeString;
      sl += " ";
    }
    sl += "-jar";
    $("#fsc").val(sl);

    $("#final-mem").html($("#xmx").val() + " GB");
    fn = $("#g-core-input")[0].value.split(/(\\|\/)/g).pop();
    if ($("#second-stage .card.active").data("core") == "own") {
      if (fn.match(/forge-/gm) && fn.match(/-installer\.jar/gm)) {
        $(".corever").text("Forge");
      } else {
        $(".corever").text("Own");
      }
    }
  }

  function createServer() {
    if ($("#fsc").val() != "" && $(".sn").text() != "" && $("#xmx").val() != "" && $("#serverport").val() !=
      "" && $(".corever").html() != "") {
      $("#progress-card").show();
      $("#progress-card .progress-bar").css("width", "100%");
      $("#progress-card p").html("{{search-core-sw}}");
      showLoading();
      sname = $(".sn").text();
      startLine = '"' + $("#cur-jv").html() + '"' + " " + $("#fsc").val();
      onlineMode = $("#onlinemodeCheckbox").is(":checked");
      core = $(".corever").html();
      port = $("#serverport").val();
      if (core.substring(0, 1) == "P") {
        $.get("/cores/paper/search?core=" + core, function (data) {
          if (data != "") {
            $("#progress-card p").html("{{down-core-sw}}");
            $.get("/downloader/download?url=" + data + "&server=" + sname + "&filename=" + data.substring(data
              .lastIndexOf('/') + 1) + "&type=core");
            rr = setInterval(function () {
              getProgress(data.substring(data.lastIndexOf('/') + 1), sname, startLine, port, onlineMode)
            }, 100);
          }
        });
      } else if (core.substring(0, 1) == "S") {
        $.get("/cores/spigot/search?core=" + core, function (data) {
          if (data != "") {
            $("#progress-card p").html("{{down-core-sw}}");
            $.get("/downloader/download?url=" + data + "&server=" + sname + "&filename=" + data.substring(data
              .lastIndexOf('/') + 1) + "&type=core");
            rr = setInterval(function () {
              getProgress(data.substring(data.lastIndexOf('/') + 1), sname, startLine, port, onlineMode)
            }, 100);
          }
        });
      } else if (core.substring(0, 2) == "Ow" || core.substring(0, 2) == "Fo") {
        var formData = new FormData($("#g-core-form")[0]);
        jQuery.ajax({
          url: '/upload/core?server=' + sname,
          type: "POST",
          data: formData,
          success: function (data) {
            jarfile = $("#g-core-input")[0].value.split(/(\\|\/)/g).pop();
            $("#progress-card .progress-bar").css("width", "100%");
            $("#progress-card p").html("{{completion-text-sw}}");
            if (core.substring(0, 2) == "Fo") {
              $("#progress-card .progress-bar").css("width", "0%");
              $("#progress-card p").html("{{forge-ins-text-sw}}");
              $("#progress-card #forgeins").show();
              $("#progress-card #forgeins").text("");
              $.get("/forgeInstaller/start?server=" + encodeURI(sname) + "&filename=" + jarfile);
              iint = setInterval(function () {
                $.get("/forgeInstaller/progress?server=" + encodeURI(sname), function (get) {
                  if (get != "allisok") {
                    get = get.split(/\r?\n/).slice(-100);
                    get = get.join("<br>");
                    $("#progress-card #forgeins").html(get);
                    $("#progress-card #forgeins").scrollTop($("#progress-card #forgeins")[0]
                      .scrollHeight);
                  } else {
                    $.get("/server/completion?server=" + encodeURI(sname) + "&jf=" + jarfile
                      .replace(/-installer/gm, "") +
                      "&startcmd=" + btoa(
                        startLine) + "&port=" + port + "&onMode=" + onlineMode,
                      function (data) {
                        if (data == "Success") {
                          window.localStorage.setItem("selectedServer", sname);
                          window.location = "/";
                        }
                      });
                  }
                });
              }, 500);
            } else {
              $.get("/server/completion?server=" + encodeURI(sname) + "&jf=" + jarfile.replace(
                  /-installer/gm, "") +
                "&startcmd=" + btoa(
                  startLine) + "&port=" + port + "&onMode=" + onlineMode,
                function (data) {
                  if (data == "Success") {
                    window.localStorage.setItem("selectedServer", sname);
                    window.location = "/";
                  }
                });
            }
          },
          error: function (data) {
            $("#progress-card .progress-bar").css("width", "0%");
            $("#progress-card p").html("Error: " + data.statusText);
          },
          cache: false,
          contentType: false,
          processData: false,
        });
      }
    }
  }

  function getProgress(jarfile, sname, startcmd, port, onmode) {
    $.get("/tasks/progress", function (data) {
      if (typeof (old_rgr) === "undefined" || old_rgr != data) {
        if (typeof (old_rgr) !== "undefined") {
          keys1 = Object.keys(data);
          keys2 = Object.keys(old_rgr);
          diff = arr_diff(keys1, keys2);
          diff.forEach(function (diffi) {
            if (diffi == jarfile) {
              $("#progress-card .progress-bar").css("width", "100%");
              clearInterval(rr);
              $("#progress-card p").html("{{completion-text-sw}}");
              $.get("/server/completion?server=" + encodeURI(sname) + "&jf=" + jarfile + "&startcmd=" + btoa(
                startcmd) + "&port=" + port + "&onMode=" + onmode, function (data) {
                if (data == "Success") {
                  window.localStorage.setItem("selectedServer", sname);
                  window.location = "/";
                }
              });
            }
          });
        }
        old_rgr = data;
      }
      if (data[jarfile] !== "undefined") {
        $("#progress-card .progress-bar").css("width", data[jarfile] + "%");
        $("#progress-card p").html("{{downing-core-sw}} " + jarfile + " (" + data[jarfile] + "%)");
      } else {
        $("#progress-card .progress-bar").css("width", "100%");
        clearInterval(rr);
        $("#progress-card p").html("{{completion-text-sw}}");
      }

    });
  }

  function arr_diff(a1, a2) {
    var a = [],
      diff = [];
    for (var i = 0; i < a1.length; i++) {
      a[a1[i]] = true;
    }
    for (var i = 0; i < a2.length; i++) {
      if (a[a2[i]]) {
        delete a[a2[i]];
      } else {
        a[a2[i]] = true;
      }
    }
    for (var k in a) {
      diff.push(k);
    }
    return diff;
  };

  function round512(x) {
    return Math.ceil(x / 512) * 512;
  }

  function loadCores() {
    console.log("[UI]", "Loading cores versions");
    $.get("/cores/list", function (cores) {
      cores.paper.forEach(ver => {
        $("#paper-versel").append("<option value='" + ver + "'>Paper " + ver + "</option>");
      });
      cores.spigot.forEach(ver => {
        $("#spigot-versel").append("<option value='" + ver + "'>Spigot " + ver + "</option>");
      });
      console.log("[UI]", "Successfully loaded");
    });
  }

  function loadThirdStage() {
    $("#third-stage .sn").text($("#first-stage input").val());
    if(selectedCoreVersion != null){
      $("#third-stage .corever").text(selectedCore + " " + selectedCoreVersion);
    } else {
      $("#third-stage .corever").text(selectedCore);
    }
    $("#serverport").val(25565);
    $.get("/kubek/javaVersions", function (jv) {
      jv.forEach(function (jfile) {
        $("#java-vers-dropdown").append('<li><a class="dropdown-item" href="#">' + jfile + '</a></li>');
      });
      $("#cur-jv").text(jv[0]);
      $("#java-vers-dropdown li a").click(function () {
        $("#cur-jv").text($(this).html());
      });
    });
  }
</script>

<style>
  body {
    padding: 3%;
  }

  * {
    color: black;
    transition: .1s !important;
  }

  .layout {
    display: grid;
    grid-template-columns: 1fr;
    grid-template-rows: max-content 1fr max-content;
    grid-auto-columns: 1fr;
    gap: 0px 0px;
    width: 100%;
    height: 100%;
    grid-auto-flow: row;
    grid-template-areas:
      "header"
      "content"
      "buttons";
  }

  .layout .header {
    align-self: center;
    grid-area: header;
  }

  .layout .content {
    grid-area: content;
  }

  .layout .buttons {
    justify-self: end;
    align-self: center;
    grid-area: buttons;
  }

  #logo-flex {
    width: max-content;
    height: max-content;
  }

  .progress-bar,
  .progress {
    border-radius: 24px;
  }

  #first-stage {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  #current-stage-text {
    font-size: 18pt;
    font-weight: 600;
    margin-top: 8px;
  }

  #second-stage {
    width: 100%;
    height: 100%;
  }

  #second-stage .card {
    width: 18%
  }

  #second-stage .card.active {
    border: 3px solid var(--mdb-primary);
  }

  #paper-versel,
  #spigot-versel {
    border: none;
    height: 32px;
    border-radius: 4px;
    padding: 5px 12px;
    outline: none;
    width: 100%;
  }

  #third-stage .input-group-text {
    height: 100%;
  }

  /* Loading overlay */
  #loading-overlay {
    position: absolute;
    left: 0;
    right: 0;
    top: 0;
    bottom: 0;
    background: rgb(0, 0, 0, 0.3);
    backdrop-filter: blur(3px);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
  }
</style>

<script>
  $("#second-stage .card").click(function () {
    if (!$(this).hasClass("active")) {
      $("#second-stage .card.active").removeClass("active");
      $(this).addClass("active");
    }
  });
</script>