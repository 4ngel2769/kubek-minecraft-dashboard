<head>
  <!-- Meta -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Kubek - Minecraft Servers</title>

  <!-- MDB -->
  <script src="js/mdb.min.js"></script>
  <link rel="stylesheet" href="css/mdb.min.css">

  <!-- Others -->
  <script src="js/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="css/animate.min.css" />
  <link rel="stylesheet" href="css/toastify.min.css" />
  <script src="js/socket.io.min.js"></script>
  <script src="js/toastify-js.js"></script>
  <script src="js/sweetalert2.all.min.js"></script>

  <!-- Own -->
  <link rel="stylesheet" href="css/globals.css" />
  <link rel="stylesheet" href="css/template.nav.css" />
  <script src="js/funcs.js"></script>

  <!-- Fonts and icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Open Sans:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
    rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Page unique -->
  <link rel="stylesheet" href="css/pages/dashboard.css">

  <!-- 
    #table-server-version (Paper 1.18.2)
    #table-server-online (4/20 players)
    #table-server-os (windows 10 pro)
    #table-server-plugins-count (100)
    #usage-memory-pbar (set width and aria-valuenow)
    #usage-memory-percent (50%)
    #usage-memory-count (0.5 / 5 GB)
    #usage-cpu-pbar (set width and aria-valuenow)
    #usage-cpu-percent (50%)
    #addr-local (127.0.0.1)
    #addr-public (127.0.0.1)
    #addr-ngrok (127.0.0.1)
  -->
</head>

<body>
  <div id="oldc">
    <div class="dashboard">
      <div class="item">
        <p class="fs-5 fw-bold text-black">{{about-server}}</p>
        <div class="card border border-primary shadow-0" style="height: 11.7rem;">
          <div class="card-body">
            <table class="table">
              <tbody>
                <tr>
                  <th style="text-align:left;">{{server-version}}</th>
                  <td style="text-align:right;" id="table-server-version">Unknown</td>
                </tr>
                <tr>
                  <th style="text-align:left;">{{online}}</th>
                  <td style="text-align:right;" id="table-server-online">Unknown</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="item">
        <p class="fs-5 fw-bold text-black">{{resource-usage}}</p>
        <div class="card border border-primary shadow-0">
          <div class="card-body">
            <div class="usage-pbar">
              <div class="percent" id="usage-memory-percent">0%</div>
              <div class="progress">
                <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0"
                  aria-valuemax="100" id="usage-memory-pbar"></div>
              </div>
              <div class="name">RAM</div>
              <div class="count" id="usage-memory-count">Unknown</div>
            </div>
          </div>
        </div>
        <div class="card border border-primary shadow-0" style="margin-top: 10px;">
          <div class="card-body">
            <div class="usage-pbar">
              <div class="percent" id="usage-cpu-percent">0%</div>
              <div class="progress">
                <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0"
                  aria-valuemax="100" id="usage-cpu-pbar"></div>
              </div>
              <div class="name">CPU</div>
              <div class="count"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="item">
        <p class="fs-5 fw-bold text-black">{{ip-adresses}}</p>
        <div class="card border border-primary shadow-0">
          <div class="card-body">
            <span id="addr-capt-local">Local IP</span>
            <input style="margin-top: 4px; margin-bottom: 8px;" class="form-control" id="addr-local" type="text"
              readonly value="Unknown" />
            <span id="addr-capt-publ">Public IP</span>
            <input style="margin-top: 4px; margin-bottom: 8px;" class="form-control" id="addr-public" type="text"
              readonly value="Unknown" />
            <span id="addr-capt-ngrok">ngrok IP</span>
            <input style="margin-top: 4px;" class="form-control" id="addr-ngrok" type="text" readonly value="Unknown" />
          </div>
        </div>
      </div>
    </div>
  </div>
</body>

<script>
  var socket;
  var memoryUpdInterval;
  var queryUpdInterval;

  $(document).ready(function () {
    loadTemplate(function () {
      hideLoading();
    });
    socket = openSocket();
    socket.on("handshake", function () {
      $.get("/server/ips?server=" + currentServer, function (ips) {
        if (typeof ips.ngrok !== "undefined") {
          $("#addr-capt-ngrok").show();
          $("#addr-ngrok").show();
          $("#addr-ngrok").val(ips.ngrok);
        } else {
          $("#addr-capt-ngrok").hide();
          $("#addr-ngrok").hide();
          $("#addr-ngrok").val("");
        }
        $("#addr-public").val(ips.public);
        $("#addr-local").val(ips.local);
      });
      console.log("Socket handshake success");
      memoryUpdInterval = setInterval(function () {
        socket.emit("update", {
          type: "usage"
        });
      }, 3000);
      queryUpdInterval = setInterval(function () {
        if ($("#server-status").text() == "Online") {
          socket.emit("update", {
            type: "query",
            server: currentServer
          });
        } else {
          $("#table-server-version").text("Unknown");
          $("#table-server-online").text("Unknown");
        }
      }, 6000);
      if ($("#server-status").text() == "Online") {
        socket.emit("update", {
          type: "query",
          server: currentServer
        });
      } else {
        $("#table-server-version").text("Unknown");
        $("#table-server-online").text("Unknown");
      }
      socket.emit("update", {
        type: "usage"
      });
      socket.emit("update", {
        type: "servers"
      });
    });
    socket.on("handleUpdate", function (arg) {
      type = arg.type;
      data = arg.data;
      switch (type) {
        case "usage":
          $("#usage-cpu-pbar").css("width", data.cpu + "%");
          $("#usage-cpu-pbar").prop("aria-valuenow", data.cpu);
          $("#usage-cpu-percent").text(data.cpu + "%");
          memUsage = (data.usedmem / 1024 / 1024 / 1024).toFixed(1) + " GB / " + (data.totalmem / 1024 / 1024 /
            1024).toFixed(1) + " GB";
          memPercent = Math.round(data.usedmem / data.totalmem * 100);
          $("#usage-memory-count").text(memUsage);
          $("#usage-memory-pbar").css("width", memPercent + "%");
          $("#usage-memory-pbar").prop("aria-valuenow", memPercent);
          $("#usage-memory-percent").text(memPercent + "%");
          break;
        case "servers":
          if (data[currentServer].status == "stopped") {
            $("#server-status").removeClass("badge-success badge-warning");
            $("#server-status").addClass("badge-danger");
            $("#server-status").html("Offline");
            $("#server-start-button").show();
            $("#server-stop-button").hide();
          } else if (data[currentServer].status == "started") {
            $("#server-status").removeClass("badge-danger badge-warning");
            $("#server-status").addClass("badge-success");
            $("#server-status").html("Online");
            $("#server-start-button").hide();
            $("#server-stop-button").show();
          } else if (data[currentServer].status == "starting") {
            $("#server-status").removeClass("badge-success badge-danger");
            $("#server-status").addClass("badge-warning");
            $("#server-status").html("Starting");
            $("#server-start-button").hide();
            $("#server-stop-button").hide();
          } else if (data[currentServer].status == "stopping") {
            $("#server-status").removeClass("badge-success badge-danger");
            $("#server-status").addClass("badge-warning");
            $("#server-status").html("Stopping");
            $("#server-start-button").hide();
            $("#server-stop-button").hide();
          }
          break;
        case "query":
          $("#table-server-version").text(data.server_modification.name);
          $("#table-server-online").text(data.players.online + "/" + data.players.max + " players");
          console.log(data.players);
          break;
        case "downloadTasks":
          $(".ntc-pool").html("");
          Object.keys(data).forEach(function (k) {
            $(".ntc-pool").append(
              '<div class="ntc ntc-poolbox" style="background: rgb(43,53,63); color: white;"><div class="ntb">Downloading ' +
              k + ' (' + data[k] + '%)</div><div class="ntb"><progress max="100" value="' + data[k] +
              '" class="pnf"></progress></div></div>');
          });
          break;
      }
    });
  });
</script>