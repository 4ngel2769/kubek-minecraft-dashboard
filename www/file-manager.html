<head>
  <!-- Meta -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Kubek - Minecraft Servers</title>

  <!-- MDB -->
  <script src="js/mdb.min.js"></script>
  <link rel="stylesheet" href="css/mdb.min.css">

  <!-- Others -->
  <script src="js/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="css/animate.min.css" />
  <link rel="stylesheet" href="css/toastify.min.css" />
  <script src="js/socket.io.min.js"></script>
  <script src="js/toastify-js.js"></script>
  <script src="js/sweetalert2.all.min.js"></script>

  <!-- Own -->
  <link rel="stylesheet" href="css/globals.css" />
  <link rel="stylesheet" href="css/template.nav.css" />
  <script src="js/funcs.js"></script>

  <!-- Fonts and icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Open Sans:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
    rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Page unique -->
  <link rel="stylesheet" href="css/pages/filemanager.css">
</head>

<body>
  <div id="oldc">
    <p class="fs-1 fw-bold">File manager</p>
    <div class="cdirDiv"></div><br>
    <button type="button" class="btn btn-link" data-mdb-ripple-color="dark" onclick=newdirFM()>{{new-directory}}</button>
    <table class="table table-hover">
      <thead>
        <tr>
          <th scope="col"></th>
          <th scope="col">Name</th>
          <th scope="col">Size</th>
          <th scope="col">Actions</th>
        </tr>
      </thead>
      <tbody id="fmtable"></tbody>
    </table>

    <div class="modal top fade" id="feModal" tabindex="-1" aria-labelledby="feModalLabel" aria-hidden="true"
      data-mdb-backdrop="static" data-mdb-keyboard="false">
      <div class="modal-dialog modal-xl  modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="feModalLabel">Modal title</h5>
            <button type="button" class="btn-close" data-mdb-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="form-outline">
              <textarea class="form-control" id="textAreaExample" rows="10"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-mdb-dismiss="modal">
              {{cancel}}
            </button>
            <button type="button" class="btn btn-primary" onclick="saveFile()"
              data-mdb-dismiss="modal">{{save}}</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>

<style>

</style>

<script>
  var socket;
  var curDir = "/";

  function upperDir() {
    curDir = curDir.split("/");
    curDir.pop();
    curDir.pop();
    curDir = curDir.join("/") + "/";
    refreshDir();
  }

  function deleteFM(path) {
    fn = path.split("/").slice(-1)[0];

    Swal.fire({
      title: '{{aredelete}}',
      text: fn,
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: '{{yesdelete}}',
      cancelButtonText: '{{cancel}}'
    }).then((result) => {
      if (result.isConfirmed) {
        $.get("/fmapi/deleteFM?server=" + currentServer + "&path=" + path, function () {
          refreshDir();
        });
      }
    })
  }

  function newdirFM(){
    Swal.fire({
      title: '{{new-directory}}',
      input: 'text',
      inputAttributes: {
        autocapitalize: 'off'
      },
      showCancelButton: true,
      confirmButtonText: '{{create}}',
      cancelButtonText: '{{cancel}}',
      showLoaderOnConfirm: false,
      preConfirm: (login) => {
        return fetch("/fmapi/newdirFM?server=" + currentServer + "&path=" + curDir + "&newdir=" + btoa(login))
          .then(response => {
            if (!response.ok) {
              throw new Error(response.statusText)
            }
            return response.json()
          })
          .catch(error => {
            Swal.showValidationMessage(
              `Request failed: ${error}`
            )
          })
      },
      allowOutsideClick: () => !Swal.isLoading()
    }).then((result) => {
      if (result.isConfirmed) {
        refreshDir();
      }
    })
  }

  function renameFM(path) {
    fn = path.split("/").slice(-1)[0];

    Swal.fire({
      title: '{{dorename}} ' + fn + "?",
      input: 'text',
      inputAttributes: {
        autocapitalize: 'off'
      },
      showCancelButton: true,
      confirmButtonText: '{{rename}}',
      cancelButtonText: '{{cancel}}',
      showLoaderOnConfirm: false,
      preConfirm: (login) => {
        return fetch("/fmapi/renameFM?server=" + currentServer + "&path=" + path + "&newname=" + btoa(login))
          .then(response => {
            if (!response.ok) {
              throw new Error(response.statusText)
            }
            return response.json()
          })
          .catch(error => {
            Swal.showValidationMessage(
              `Request failed: ${error}`
            )
          })
      },
      allowOutsideClick: () => !Swal.isLoading()
    }).then((result) => {
      if (result.isConfirmed) {
        refreshDir();
      }
    })
  }

  function saveFile() {
    fn = $("#feModalLabel").text();
    path = curDir + fn;
    $.get("/fmapi/saveFile?server=" + currentServer + "&path=" + path + "&text=" + btoa($(
      "#feModal .modal-body textarea").val()), function () {});
  }

  function refreshDir() {
    $("#fmtable").html("");
    $(".cdirDiv").html("<span class='fw-bold' style='color: rgb(150,150,150);'>" + currentServer + " â€¢ </span>");
    spl = curDir.split("/");
    spl = spl.filter(element => {
      return element != "";
    });
    $(".cdirDiv").append("<span> / </span>");
    if (spl != "/") {
      spl.forEach(function (dir) {
        $(".cdirDiv").append("<span class='fw-bold'>" + dir + "</span>");
        $(".cdirDiv").append("<span> / </span>");
      });
    }

    if (curDir != "/") {
      $("#fmtable").append(
        '<tr ondblclick="upperDir()"><td></td><td class="fn">..</td><td></td><td></td></tr>');
    }
    $.get("/fmapi/scanDirectory?server=" + currentServer + "&directory=" + curDir, function (data) {
      data = JSON.parse(data);
      if (typeof data == "object") {
        data.forEach(function (file) {
          size = 0;
          if (file.size < 1024 * 1024) {
			size = Math.round(file.size / 1024 * 10) / 10 + " Kb";
          }
          if (file.size < 1024) {
            size = file.size + " B";
          }
          if (file.size >= 1024 * 1024) {
            size = Math.round(file.size / 1024 / 1024 * 10) / 10 + " Mb";
          }
		  if (file.size >= 1024 * 1024 * 1024) {
            size = Math.round(file.size / 1024 / 1024 / 1024 * 10) / 10 + " Gb";
          }
          if (file.type == "directory") {
            act =
              '<div class="btn-group btn-group-sm" role="group" aria-label="Actions"><button type="button" class="btn btn-primary" onclick=renameFM("' +
              curDir + file.name +
              '")><span style="font-size: 10pt;" class="material-icons">border_color</span></button></div>';
          } else {
            act =
              '<div class="btn-group btn-group-sm" role="group" aria-label="Actions"><button type="button" class="btn btn-primary" onclick=deleteFM("' +
              curDir + file.name +
              '")><span style="font-size: 10pt;" class="material-icons">delete</span></button><button type="button" class="btn btn-primary" onclick=renameFM("' +
              curDir + file.name +
              '")><span style="font-size: 10pt;" class="material-icons">border_color</span></button></div>';
          }
          if (file.type == "directory") {
            icon = "folder";
          } else if (file.type == "file") {
            icon = "description";
          } else {
            icon = "question_mark";
          }
          if (file.type == "directory") {
            size = "";
          }
          $("#fmtable").append(
            '<tr data-type="' + file.type +
            '"><td style="width: 20px;"><span class="material-icons">' + icon + '</span></td><td class="fn" style="padding-top: 18px;">' +
            file.name + '</td><td>' + size + '</td><td>' + act + '</td></tr>');
        });
        $("#fmtable").unbind("click");
        $("#fmtable tr").dblclick(function () {
          if ($(this).data("type") == "directory") {
            curDir += $(this).find(".fn")[0].innerText + "/";
            refreshDir();
          }
          if ($(this).data("type") == "file") {
            ext = $(this).find(".fn")[0].innerText.split(".").slice(-1)[0];
            allowedExt = ["txt", "log", "yml", "xml", "cfg", "conf", "config", "json", "yaml", "properties"];
            if (allowedExt.indexOf(ext) >= 0) {
              $("#feModalLabel").text($(this).find(".fn")[0].innerText);
              $.get("/fmapi/getFile?server=" + currentServer + "&path=" + curDir + $(this).find(".fn")[0]
                .innerText,
                function (data) {
                  $("#feModal .modal-body textarea").val(data);
                  myModal = new mdb.Modal(document.getElementById('feModal'));
                  myModal.show();
                });
            }
          }
        });
      }
    });
  }

  $(document).ready(function () {
    function findGetParameter(parameterName) {
      var result = null,
        tmp = [];
      location.search
        .substr(1)
        .split("&")
        .forEach(function (item) {
          tmp = item.split("=");
          if (tmp[0] === parameterName) result = decodeURIComponent(tmp[1]);
        });
      return result;
    }

    loadTemplate(function () {
      hideLoading();
    });

    socket = openSocket();
    socket.on("handshake", function () {
      console.log("Socket handshake success");
      socket.emit("update", {
        type: "servers"
      });
      refreshDir();
    });
    socket.on("handleUpdate", function (arg) {
      type = arg.type;
      data = arg.data;
      switch (type) {
        case "servers":
          if (data[currentServer].status == "stopped") {
            $("#server-status").removeClass("badge-success badge-warning");
            $("#server-status").addClass("badge-danger");
            $("#server-status").html("Offline");
            $("#server-start-button").show();
            $("#server-stop-button").hide();
          } else if (data[currentServer].status == "started") {
            $("#server-status").removeClass("badge-danger badge-warning");
            $("#server-status").addClass("badge-success");
            $("#server-status").html("Online");
            $("#server-start-button").hide();
            $("#server-stop-button").show();
          } else if (data[currentServer].status == "starting") {
            $("#server-status").removeClass("badge-success badge-danger");
            $("#server-status").addClass("badge-warning");
            $("#server-status").html("Starting");
            $("#server-start-button").hide();
            $("#server-stop-button").hide();
          } else if (data[currentServer].status == "stopping") {
            $("#server-status").removeClass("badge-success badge-danger");
            $("#server-status").addClass("badge-warning");
            $("#server-status").html("Stopping");
            $("#server-start-button").hide();
            $("#server-stop-button").hide();
          }
          break;
        case "downloadTasks":
          $(".ntc-pool").html("");
          Object.keys(data).forEach(function (k) {
            $(".ntc-pool").append(
              '<div class="ntc ntc-poolbox" style="background: rgb(43,53,63); color: white;"><div class="ntb">Downloading ' +
              k + ' (' + data[k] + '%)</div><div class="ntb"><progress max="100" value="' + data[k] +
              '" class="pnf"></progress></div></div>');
          });
          break;
      }
    });
  });
</script>