<head>
  <!-- Meta -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Kubek - Minecraft Servers</title>

  <!-- MDB -->
  <script src="js/mdb.min.js"></script>
  <link rel="stylesheet" href="css/mdb.min.css">

  <!-- Others -->
  <script src="js/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="css/animate.min.css" />
  <link rel="stylesheet" href="css/toastify.min.css" />
  <script src="js/socket.io.min.js"></script>
  <script src="js/toastify-js.js"></script>
  <script src="js/sweetalert2.all.min.js"></script>

  <!-- Own -->
  <link rel="stylesheet" href="css/globals.css" />
  <link rel="stylesheet" href="css/template.nav.css" />
  <script src="js/funcs.js"></script>

  <!-- Fonts and icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Open Sans:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
    rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Page unique -->
  <link rel="stylesheet" href="css/pages/console.css">

  <!-- 
    #console (text)
    #command-input (event)
    #autoscroll-checkbox (checkbox)
    #update-console-checkbox (checkbox)
  -->
</head>

<body>
  <div id="oldc">
    <div class="window w-100 h-100">
      <div class="header">
        <div class="d-flex w-100 align-items-center">
          <div class="flex-fill">{{console}}</div>
          <div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="" id="autoscroll-checkbox" checked />
              <label class="form-check-label" for="autoscroll-checkbox">{{autoscroll-console}}</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="" id="update-console-checkbox"
                onchange='socket.emit("update", {type: "console",server: currentServer});' checked />
              <label class="form-check-label" for="update-console-checkbox">{{autoupdate-console}}</label>
            </div>
          </div>
        </div>
      </div>
      <div class="content w-100 h-100 d-flex flex-column" style="height: 65vh; box-sizing: unset;">
        <div class="console" id="console" style="height: 65vh; overflow: auto;">Loading data...</div>
        <div class="input d-flex w-100 align-items-center">
          <input type="text" id="command-input" placeholder="{{enter-command}}"
            onkeyup="if(event.key == 'Enter'){$.get('/server/sendCommand?server=' + currentServer + '&cmd=' + this.value); this.value = ''}">
        </div>
      </div>
    </div>
  </div>
</body>

<script>
  var socket;
  $(document).ready(function () {
    loadTemplate(function () {
      // wait
    });
    socket = openSocket();
    socket.on("handshake", function () {
      socket.emit("update", {
        type: "servers"
      });
      socket.emit("update", {
        type: "console",
        server: currentServer
      });
    });
    socket.on("handleUpdate", function (arg) {
      type = arg.type;
      data = arg.data;
      switch (type) {
        case "console":
          if (data.server == currentServer && $("#update-console-checkbox").is(":checked")) {
            split = data.data.split(/\r?\n/);
            $(".console").html("");
            split.forEach(function (line) {
              if (line.search("ERROR") != -1) {
                $(".console").append("<span style='background: rgba(249, 49, 84, 0.1); color: #F93154;'>" +
                  line + "</span><br>");
              } else if (line.search("WARN") != -1) {
                $(".console").append("<span style='background: rgba(255, 169, 0, 0.1); color: #FFA900;'>" +
                  line + "</span><br>");
              } else {
                $(".console").append("<span>" + line + "</span><br>");
              }
            });
            if ($("#autoscroll-checkbox").is(":checked")) {
              $(".console").scrollTop($(".console")[0].scrollHeight);
            }
            hideLoading();
          }
          break;
        case "servers":
          if (data[currentServer].status == "stopped") {
            $("#server-status").removeClass("badge-success badge-warning");
            $("#server-status").addClass("badge-danger");
            $("#server-status").html("Offline");
            $("#server-start-button").show();
            $("#server-stop-button").hide();
          } else if (data[currentServer].status == "started") {
            $("#server-status").removeClass("badge-danger badge-warning");
            $("#server-status").addClass("badge-success");
            $("#server-status").html("Online");
            $("#server-start-button").hide();
            $("#server-stop-button").show();
          } else if (data[currentServer].status == "starting") {
            $("#server-status").removeClass("badge-success badge-danger");
            $("#server-status").addClass("badge-warning");
            $("#server-status").html("Starting");
            $("#server-start-button").hide();
            $("#server-stop-button").hide();
          } else if (data[currentServer].status == "stopping") {
            $("#server-status").removeClass("badge-success badge-danger");
            $("#server-status").addClass("badge-warning");
            $("#server-status").html("Stopping");
            $("#server-start-button").hide();
            $("#server-stop-button").hide();
          }
          break;
        case "downloadTasks":
          $(".ntc-pool").html("");
          Object.keys(data).forEach(function (k) {
            $(".ntc-pool").append(
              '<div class="ntc ntc-poolbox" style="background: rgb(43,53,63); color: white;"><div class="ntb">Downloading ' +
              k + ' (' + data[k] + '%)</div><div class="ntb"><progress max="100" value="' + data[k] +
              '" class="pnf"></progress></div></div>');
          });
          break;
      }
    });
  });
</script>